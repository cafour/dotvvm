variables:
  DOTVVM_ARTIFACTS: $CI_PROJECT_DIR/artifacts

default:
  cache:
    paths:
      - .npm/
      - .nuget/
  artifacts:
    paths:
      - artifacts/

build-solution:
  image: registry.gitlab.com/cafstep/dotvvm-test/dotvvm
  stage: build
  script:
    - cd $CI_PROJECT_DIR/src/DotVVM.Framework
        && npm ci --cache $CI_PROJECT_DIR/.npm --prefer-offline
        && npm run build
        && cd $CI_PROJECT_DIR/src
        && dotnet restore --packages $CI_PROJECT_DIR/.nuget Crossplatform.sln
        && dotnet build --no-restore Crossplatform.sln
  only:
    - gitlab-ci-test

run-unit-tests:
  image: registry.gitlab.com/cafstep/dotvvm-test/dotvvm
  stage: test
  script:
    - dotnet test $CI_PROJECT_DIR/src/DotVVM.Framework.Tests.Common
        --no-build
        --logger "junit,LogFilePath=$CI_PROJECT_DIR/artifacts/Common.JUnit.xml"
        --configuration Release
  artifacts:
    reports:
      junit: artifacts/**/*.JUnit.xml
  only:
    - gitlab-ci-test
